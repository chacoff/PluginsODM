{% extends "app/plugins/templates/base.html" %}
{% load i18n %}

{% block content %}

<h2>{% trans 'Volume reports: developer' %}</h2>
<br />

<!-- Content dev template -->
{% if isDev %}
<p>Hej, <b>{{ current_user }}</b>, you are in developer options. <br /> Modify here the parameters for orthomosaic re-scaling.</p>

{% csrf_token %}

<div class="add-row">
    <table id="data-table">
        <thead>
        <tr>
            <th>Counter</th>
            <th>Sector</th>
            <th>Angle</th>
            <th>Crop Left</th>
            <th>Crop Top</th>
            <th>Crop Right</th>
            <th>Crop Bottom</th>
            <th>Scale</th>
            <th>Quality</th>
            <th>Reviewer</th>
            <th>Updated At</th>
            <th> </th>
        </tr>
        </thead>
        <tbody>
        {% for row in df.data %}
        <tr>
            <td>{{ row.0 }}</td>
            <td><input type="text" name="sector_{{ row.0 }}" value="{{ row.1 }}" maxlength="16" required class="form-control"></td>
            <td><input type="number" name="angle_{{ row.0 }}" value="{{ row.2 }}" step="1" class="form-control"></td>
            <td><input type="number" name="crop_left_{{ row.0 }}" value="{{ row.3 }}" step="1" class="form-control"></td>
            <td><input type="number" name="crop_top_{{ row.0 }}" value="{{ row.4 }}" step="1" class="form-control"></td>
            <td><input type="number" name="crop_right_{{ row.0 }}" value="{{ row.5 }}" step="1" class="form-control"></td>
            <td><input type="number" name="crop_bottom_{{ row.0 }}" value="{{ row.6 }}" step="1" class="form-control"></td>
            <td><input type="number" name="scale_{{ row.0 }}" value="{{ row.7 }}" step="0.01" min="0" max="1" required class="form-control"></td>
            <td><input type="number" name="quality_{{ row.0 }}" value="{{ row.10 }}" step="1" min="0" max="100" class="form-control"></td>
            <td><input type="text" name="reviewer_{{ row.0 }}" value="{{ row.8 }}" maxlength="20" class="form-control"></td>
            <td><input type="datetime-local" name="updated_at_{{ row.0 }}" value="{{ row.9 }}" class="form-control"></td>
            <td><button type="button" class="btn btn-default" onClick="deleteRow(this)">Delete</button></td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    <button type="button" class="btn btn-default" onClick="appendRow()">Add Row</button>
    <button type="submit" class="btn btn-default" onclick="UpdateTableData()">Update</button>
</div>
<br />

<div id="status-message"></div>
<!-- Content dev template -->

<style>
    table {
        width: 90%;
        border-collapse: collapse;
        margin: 16px 0;
        font-size: 13px;
        text-align: left;
    }

    table th, table td {
        border: 0px solid #ddd;
        padding: 4px;
    }

    table th {
        background-color: #f4f4f4;
        font-weight: bold;
    }

    table tr:nth-child(even) {
        background-color: #f9f9f9;
    }

    table tr:hover {
        background-color: #f9f9f9;
    }

    .add-row {
        margin-top: 20px;
    }
</style>

<script>
    let rowCount = 0;

    document.addEventListener("DOMContentLoaded", () => {
        const tableBody = document.querySelector("#data-table tbody");
        rowCount = tableBody.rows.length;
    });

    function appendRow() {
        const tableBody = document.querySelector("#data-table tbody");
        rowCount += 1;

        const newRow = `
        <tr>
            <td>${rowCount}</td>
            <td><input type="text" name="sector_${rowCount}" maxlength="16" required class="form-control"></td>
            <td><input type="number" name="angle_${rowCount}" step="1" class="form-control"></td>
            <td><input type="number" name="crop_left_${rowCount}" step="1" class="form-control"></td>
            <td><input type="number" name="crop_top_${rowCount}" step="1" class="form-control"></td>
            <td><input type="number" name="crop_right_${rowCount}" step="1" class="form-control"></td>
            <td><input type="number" name="crop_bottom_${rowCount}" step="1" class="form-control"></td>
            <td><input type="number" name="scale_${rowCount}" step="0.01" min="0" max="1" required class="form-control"></td>
            <td><input type="number" name="quality_${rowCount}" step="1" min="0" max="100" class="form-control"></td>
            <td><input type="text" name="reviewer_${rowCount}" maxlength="20" class="form-control"></td>
            <td><input type="datetime-local" name="updated_at_${rowCount}" class="form-control"></td>
            <td><button type="button" class="btn btn-default" onClick="deleteRow(this)">Delete</button></td>
        </tr>`;

        tableBody.insertAdjacentHTML("beforeend", newRow);
    }

    function deleteRow(button) {
            const row = button.closest("tr");
            row.remove();
        }

    function getTableData() {
        const table = document.getElementById("data-table");
        const rows = table.querySelectorAll("tbody tr");
        const data = [];

        rows.forEach((row) => {
            const cells = row.querySelectorAll("td");
            const rowData = {
                counter: parseInt(cells[0].textContent.trim(), 10) || null,
                sector: cells[1].querySelector("input").value.trim(),
                angle: parseInt(cells[2].querySelector("input").value.trim(), 10) || null,
                crop_left: parseInt(cells[3].querySelector("input").value.trim(), 10) || null,
                crop_top: parseInt(cells[4].querySelector("input").value.trim(), 10) || null,
                crop_right: parseInt(cells[5].querySelector("input").value.trim(), 10) || null,
                crop_bottom: parseInt(cells[6].querySelector("input").value.trim(), 10) || null,
                scale: parseFloat(cells[7].querySelector("input").value.trim()) || null,
                quality: parseInt(cells[8].querySelector("input").value.trim(), 10) || null,
                reviewer: cells[9].querySelector("input").value.trim(),
                updated_at: cells[10].querySelector("input").value.trim()
            };
            data.push(rowData);
        });

        return data;
    }

    function UpdateTableData() {
        const data = getTableData();
        const csrfToken = getCSRFToken();

        fetch("/plugins/ScrapCharts/update_dev_db/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify(data)
        }).then((response) => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
        }).then((result) => {
            console.log("Backend response:", result);
            const statusDiv = document.getElementById("status-message");
            statusDiv.innerText = result.status;
            statusDiv.style.color = "green";

            setTimeout(() => {
                statusDiv.innerText = "";
            }, 3000); // 3 s

        }).catch((error) => {
            console.error("Error:", error);
            const statusDiv = document.getElementById("status-message");
            statusDiv.innerText = "Error: " + error.message;
            statusDiv.style.color = "red";

            setTimeout(() => {
                statusDiv.innerText = "";
            }, 6000); // 6 s
        });
    }

    function getCSRFToken() {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            if (cookie.startsWith("csrftoken=")) {
                return cookie.split("=")[1];
            }
        }
        return "";
    }

</script>

{% endif %}

{% endblock %}